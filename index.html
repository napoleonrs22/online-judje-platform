<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Judge Tester</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .auth-container { max-width: 400px; margin: 50px auto; }
        .card { border: none; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .card-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px 15px 0 0; }
        .btn-auth { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; color: white; }
        .btn-auth:hover { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); color: white; }
        .btn-logout { background: #dc3545; border: none; border-radius: 8px; color: white; }
        .navbar-custom { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .app-container { display: none; }
        .auth-forms { display: block; }
        .container { max-width: 1000px; }
        textarea { font-family: 'Consolas', 'Courier New', monospace; }
        #log { max-height: 300px; overflow-y: scroll; background: #343a40; color: #fff; border-radius: 10px; font-size: 12px; }
        .nav-tabs .nav-link { color: #667eea; }
        .nav-tabs .nav-link.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    </style>
</head>
<body>
    <!-- –ù–∞–≤–±–∞—Ä -->
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container-fluid">
            <span class="navbar-brand text-white">üéì Online Judge</span>
            <div class="d-flex align-items-center gap-3 ms-auto">
                <span class="text-white" id="userInfo" style="display: none;">
                    üë§ <span id="currentUser"></span>
                </span>
                <button class="btn btn-logout" id="logoutBtn" style="display: none;" onclick="logout()">–í—ã—Ö–æ–¥</button>
            </div>
        </div>
    </nav>

    <!-- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø -->
    <div class="auth-forms" id="authForms">
        <div class="auth-container">
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" href="#register" data-bs-toggle="tab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#login" data-bs-toggle="tab">–í—Ö–æ–¥</a>
                </li>
            </ul>

            <div class="tab-content">
                <!-- –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø -->
                <div class="tab-pane fade show active" id="register">
                    <div class="card mt-3">
                        <div class="card-header">üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
                        <div class="card-body">
                            <form id="registerForm">
                                <div class="mb-3">
                                    <input type="email" class="form-control" id="regEmail" placeholder="Email" required>
                                </div>
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="regUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" required>
                                </div>
                                <div class="mb-3">
                                    <input type="password" class="form-control" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 8)" required>
                                </div>
                                <div class="mb-3">
                                    <select class="form-select" id="regRole">
                                        <option value="student">–°—Ç—É–¥–µ–Ω—Ç</option>
                                        <option value="teacher">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-auth w-100">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- –í–•–û–î -->
                <div class="tab-pane fade" id="login">
                    <div class="card mt-3">
                        <div class="card-header">üîë –í—Ö–æ–¥</div>
                        <div class="card-body">
                            <form id="loginForm">
                                <div class="mb-3">
                                    <input type="email" class="form-control" id="loginEmail" placeholder="Email" required>
                                </div>
                                <div class="mb-3">
                                    <input type="password" class="form-control" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" required>
                                </div>
                                <button type="submit" class="btn btn-auth w-100">–í–æ–π—Ç–∏</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert alert-info mt-4">
                <strong>üí° –î–µ–º–æ:</strong><br>
                Email: <code>test@example.com</code><br>
                –ü–∞—Ä–æ–ª—å: <code>password123</code><br>
                –†–æ–ª—å: <code>student</code>
            </div>
        </div>
    </div>

    <!-- –ü–†–ò–õ–û–ñ–ï–ù–ò–ï -->
    <div class="app-container" id="appContainer">
        <div class="container mt-5">
            <h1 class="mb-4 text-center text-white">–°–µ—Ä–≤–∏—Å –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Online Judge</h1>
            
            <div id="log" class="p-3 mb-4 rounded">–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:</div>

            <div class="row">
                <!-- –°–û–ó–î–ê–ù–ò–ï –ó–ê–î–ê–ß–ò -->
                <div class="col-md-6 mb-4">
                    <div class="card shadow">
                        <div class="card-header bg-primary text-white">1. –°–æ–∑–¥–∞—Ç—å –ó–∞–¥–∞—á—É</div>
                        <div class="card-body">
                            <form id="createProblemForm">
                                <input type="text" class="form-control mb-2" id="problemTitle" value="–°—É–º–º–∞ –¥–≤—É—Ö —á–∏—Å–µ–ª" required>
                                <textarea class="form-control mb-2" id="problemDescription" rows="2" required>–ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É, –∫–æ—Ç–æ—Ä–∞—è —Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–≤–∞ —Ü–µ–ª—ã—Ö —á–∏—Å–ª–∞ –∏ –≤—ã–≤–æ–¥–∏—Ç –∏—Ö —Å—É–º–º—É.</textarea>
                                <select class="form-select mb-2" id="problemDifficulty">
                                    <option value="easy">–õ–µ–≥–∫–∏–π</option>
                                    <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
                                    <option value="hard">–°–ª–æ–∂–Ω—ã–π</option>
                                </select>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="isPublic" checked>
                                    <label class="form-check-label">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</label>
                                </div>
                                <small class="d-block mb-2">–¢–µ—Å—Ç-–∫–µ–π—Å:</small>
                                <input type="text" class="form-control mb-2" id="testInput" value="10 2" placeholder="Input">
                                <input type="text" class="form-control mb-2" id="testOutput" value="12" placeholder="Output">
                                <button type="submit" class="btn btn-primary w-100">–°–æ–∑–¥–∞—Ç—å</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- –û–¢–ü–†–ê–í–ö–ê –†–ï–®–ï–ù–ò–Ø -->
                <div class="col-md-6 mb-4">
                    <div class="card shadow">
                        <div class="card-header bg-success text-white">2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –†–µ—à–µ–Ω–∏–µ</div>
                        <div class="card-body">
                            <form id="submitSolutionForm">
                                <input type="text" class="form-control mb-2" id="submissionProblemId" placeholder="ID –∑–∞–¥–∞—á–∏" required>
                                <select class="form-select mb-2" id="submissionLanguage">
                                    <option value="python">Python</option>
                                    <option value="java">Java</option>
                                    <option value="cpp">C++</option>
                                </select>
                                <textarea class="form-control mb-2" id="submissionCode" rows="8" required>a, b = map(int, input().split())
print(a + b)</textarea>
                                <button type="submit" class="btn btn-success w-100">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:8000';
        const logElement = document.getElementById('log');
        let accessToken = localStorage.getItem('accessToken') || null;
        let currentUser = localStorage.getItem('currentUser') || null;
        
        // Mock users –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const mockUsers = {};

        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            let color = 'white';
            if (type === 'success') color = '#28a745';
            if (type === 'error') color = '#dc3545';
            if (type === 'warning') color = '#ffc107';
            
            const p = document.createElement('p');
            p.innerHTML = `<span style="color: grey;">[${time}]</span> <span style="color: ${color};">${message}</span>`;
            logElement.prepend(p);
        }

        function showApp() {
            document.getElementById('authForms').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'block';
            document.getElementById('currentUser').textContent = currentUser;
        }

        function hideApp() {
            document.getElementById('authForms').style.display = 'block';
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            accessToken = null;
            currentUser = null;
            localStorage.removeItem('accessToken');
            localStorage.removeItem('currentUser');
            log('–í—ã –≤—ã—à–ª–∏', 'info');
        }

        function logout() {
            hideApp();
        }

        // –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('regEmail').value;
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;

            log(`–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: ${username}...`);

            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, username, password, role: document.getElementById('regRole').value })
                });

                const result = await response.json();
                if (response.ok) {
                    log(`‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!`, 'success');
                    mockUsers[email] = password;
                    document.getElementById('loginEmail').value = email;
                } else {
                    log(`‚ùå ${result.detail}`, 'error');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        });

        // –í–•–û–î
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            log(`–í—Ö–æ–¥: ${email}...`);

            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();
                if (response.ok) {
                    accessToken = result.access_token;
                    currentUser = email;
                    localStorage.setItem('accessToken', accessToken);
                    localStorage.setItem('currentUser', currentUser);
                    log(`‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!`, 'success');
                    showApp();
                } else {
                    log(`‚ùå ${result.detail || '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'}`, 'error');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        });

        // –°–û–ó–î–ê–ù–ò–ï –ó–ê–î–ê–ß–ò
        document.getElementById('createProblemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('problemTitle').value;

            log(`–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏: ${title}...`);

            try {
                const response = await fetch(`${API_BASE_URL}/api/teacher/problems`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        title,
                        slug: title.toLowerCase().replace(/\s+/g, '-'),
                        description: document.getElementById('problemDescription').value,
                        difficulty: document.getElementById('problemDifficulty').value,
                        checker_type: "exact",
                        examples: [],
                        test_cases: [{
                            input_data: document.getElementById('testInput').value,
                            output_data: document.getElementById('testOutput').value,
                            is_sample: true
                        }],
                        is_public: document.getElementById('isPublic').checked
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    log(`‚úÖ –ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞! ID: ${result.problem_id}`, 'success');
                    document.getElementById('submissionProblemId').value = result.problem_id;
                } else {
                    log(`‚ùå ${result.detail}`, 'error');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        });

        // –û–¢–ü–†–ê–í–ö–ê –†–ï–®–ï–ù–ò–Ø
        document.getElementById('submitSolutionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            log(`–û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ—à–µ–Ω–∏—è...`);

            try {
                const response = await fetch(`${API_BASE_URL}/api/student/submissions`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        problem_id: document.getElementById('submissionProblemId').value,
                        language: document.getElementById('submissionLanguage').value,
                        code: document.getElementById('submissionCode').value
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    const status = result.final_status || result.status;
                    log(`‚úÖ ${status}`, status === 'ACCEPTED' ? 'success' : 'warning');
                } else {
                    log(`‚ùå ${result.detail}`, 'error');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        });

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
        window.addEventListener('load', () => {
            if (accessToken && currentUser) {
                showApp();
                log(`–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Å–µ—Å—Å–∏—è: ${currentUser}`, 'info');
            }
        });
    </script>
</body>
</html>